---
title: "Marking with LLM"
output: 
  html_document:
    theme:
      version: 5
      bootswatch: lux
params:
  result_list: !r list(df = data.frame(text = c("a", "b", "c"), result = c("A", "B", "C")), categories = c("A", "B", "C"), scoring_characteristic = "onderwerp", model = "gpt-4o", irr = list(subjects = 20, raters = 2, irr.name = "Kappa", stat.name = "z", statistic = 1.163762, p.value = 0.243845, value = 0.119469))
---

```{r include=FALSE, error=TRUE}
rl <- params$result_list
source(here::here("R", "report_datatable_config.R"), local = TRUE)
source(here::here("R", "report_quote_utils.R"), local = TRUE)
```

## Method

There were `r length(unique(rl$df$text))` texts analyzed with a large language model (LLM) (model: `r htmltools::htmlEscape(rl$model)`),
where the LLM was asked to mark texts that belonged to one of the following codes:

```{r echo=FALSE, results='asis', error=TRUE}
cat("<blockquote>")
cat(paste0("* *", htmltools::htmlEscape(rl$codes), "*"), sep = "\n")
cat("</blockquote>")
```

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$paragraphs)) {
  cat(paste0(
    "With the texts that were marked, a language model (",
    htmltools::htmlEscape(rl$model), ") has finally written a report.", "\n",
    "For each code, a summary of what was said is provided in the report."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
research_background <- rl$research_background
research_background <- htmltools::htmlEscape(research_background)
if (
  !is.null(rl$research_background)
  && research_background != ""
) {
  cat(paste0(
    "### Research background\n",
    "The user provided the following background information about the research:\n\n",
    "<blockquote><i>",
  research_background,
    "</i></blockquote>", "\n\n",
    "This information was added to each prompt sent to the language model, so that it could better understand the context of the research."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
# if (!is.null(rl$irr)) {
#   cat(paste0(
#     "### Betrouwbaarheid\n",
#     "De interbeoordelaarsbetrouwbaarheid tussen het taalmodel en een menselijke beoordelaar berekend.",
#     " Hiervoor is een willekeurige steekproef genomen van " , 
#     rl$irr$subjects, " teksten.",
#     " De berekende interbeoordelaarsbetrouwbaarheid is ",
#     round(rl$irr$value, 3), " (", rl$irr$irr.name, "; ", rl$irr$stat.name, " = ", 
#     round(rl$irr$statistic, 3), ", p = ", round(rl$irr$p.value, 3), ").",
#     " Dit valt te interpreteren als een ",
#     dplyr::case_when(
#       rl$irr$value < 0 ~ "slechte ('poor')",
#       rl$irr$value < 0.2 ~ "zwakke ('slight')",
#       rl$irr$value < 0.4 ~ "matige ('fair')",
#       rl$irr$value < 0.6 ~ "redelijke ('moderate')",
#       rl$irr$value < 0.8 ~ "goede ('substantial')",
#       rl$irr$value < 1 ~ "zeer goede ('almost perfect')",
#       TRUE ~ "perfecte"
#     ),
#     " overeenstemming tussen het taalmodel en de menselijke beoordelaar ([Landis & Koch, 1977](https://doi.org/10.2307/2529310))."
#   ))
# }
```

## Results

### Marked texts

Below table shows for each text and code which part of the text was marked by the language model.

Column 'Text' contains the original text, column 'Subtext' contains a portion of the original text that was viewed in one prompt by the language model,
the column 'Code' contains the code for which the text was marked, and the column 'Marked text' contains the text that was marked as relevant by the language model.

```{r, echo=FALSE, results='asis', error=TRUE}

rl$df |>
  # Filter out where marked_text is NA or empty
  dplyr::filter(!is.na(marked_text) & marked_text != "") |>
  dplyr::rename(
    `Text` = text,
    `Subtext` = sub_text,
    `Code` = code,
    `Marked text` = marked_text
  ) |>
  DT::datatable(
    rownames = FALSE,
    extensions = 'Buttons',
    options = get_datatable_options_en()
  )

```

```{r echo=FALSE, results='asis', error=TRUE}
if (is.null(rl$paragraphs)) return(invisible(NULL))

output <- list()

output <- append(output, list(
  htmltools::HTML("<h3>Report</h3>"),
  htmltools::HTML("<p>The following paragraphs are the summaries of the texts per topic.</p>"),
  htmltools::div(
    class = "d-flex justify-content-center",
    htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "alert alert-warning p-2 text-center",
        style = "max-width: 500px; font-size: 0.9rem;",
        htmltools::tags$div(
          class = "d-flex align-items-center",
          bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
          htmltools::tags$small(
            htmltools::tags$i(
              "Language models can 'hallucinate'.",
              " Check whether the summaries are supported by the texts.",
              " Icons next to quotes indicate whether they appear in the texts."
            )
          )
        )
      )
    )
  )
))

## quote utils loaded from report_quote_utils.R

for (i in seq_along(rl$paragraphs)) {
  paragraph <- rl$paragraphs[[i]]
  topic <- htmltools::htmlEscape(paragraph$topic)
  paragraph_text <- htmltools::htmlEscape(paragraph$paragraph)
  
  supporting_texts <- paste(htmltools::htmlEscape(paragraph$texts), collapse = " ")
  if (length(supporting_texts) == 0) {
    next
  }
  
  #### 1 Verify quotes on presence in supporting texts ####
  paragraph_text <- verify_and_decorate_quotes(
    paragraph_text = paragraph_text,
    supporting_texts = supporting_texts,
    lang = "en",
    escape_html = FALSE
  )
  
  #### 2 Check if paragraph has attribute about prompt not fitting in context window ####
  
  # If paragraph has attribute 'prompt_fits' and it is FALSE, add a warning
  #   to the output
  warning_context_window <- NULL
  prompt_fits <- paragraph$prompt_fits
  if (isFALSE(prompt_fits)) {
    warning_context_window <- htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "d-flex justify-content-center",
        htmltools::div(
          class = "alert alert-warning p-2 text-center",
          style = "max-width: 500px; font-size: 0.9rem;",
          htmltools::tags$div(
            class = "d-flex align-items-center",
            bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
            htmltools::tags$small(
              htmltools::tags$i(
                "The prompt for the summary of this category did",
                " not fit in the context window of the language model.",
                " It is possible that not all instructions or texts were seen by the language model."
              )
            )
          )
        )
      )
    )
  }
  
  # Append processed output
  output <- append(output, list(
  htmltools::HTML(paste0("<h4>", topic, "</h4>")),
    warning_context_window,
  htmltools::HTML(paste0("<p>", paragraph_text, "</p>"))
  ))

  if (!is.null(paragraph$texts)) {
    # Convert **bold** syntax to <strong>bold</strong>
    formatted_texts <- lapply(paragraph$texts, function(txt) {
      # Replace **text** with <strong>text</strong>
      htmltools::HTML(gsub(
        "\\*\\*(.*?)\\*\\*",
        "<span style='font-weight: 900; color: #b30000; background-color: #ffcccc; text-decoration: underline;'>\\1</span>",
        htmltools::htmlEscape(txt)
      ))
    })
  
    # Create list items
    list_items <- lapply(formatted_texts, function(txt) {
      paste0("<li><i>", txt, "</i></li>")
    })
  
    acc <- bslib::accordion(
      bslib::accordion_panel(
        title = "View texts",
        htmltools::HTML(paste0("<ul>", paste0(list_items, collapse = ""), "</ul>"))
      ),
      id = paste0("acc-", i),
      open = FALSE
    )
    
    output <- append(output, list(acc))
  }

  output <- append(output, list(htmltools::HTML("<br>")))
}

if (length(rl$paragraphs) > 0) {
  htmltools::tagList(output)
}
``` 
 
```{r footer, echo=FALSE, results='asis', error=TRUE}
htmltools::tags$footer(
  style = "text-align:center; font-size: 0.8em; color: #888; margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee;",
  htmltools::HTML(paste0(
    "This analysis was performed by KWALLM, an open-source app for automated qualitative text analysis.<br>Developed by ",
    "<a href='https://www.kennispunttwente.nl' target='_blank'>Kennispunt Twente</a> in collaboration with GGD Twente.<br>",
    "Visit the <a href='https://github.com/kennispunttwente/tekstanalyse_met_llm' target='_blank'>GitHub-repository</a> for more information.",
    "<br>",
    "<br>",
    format(Sys.Date(), "%Y-%m-%d")
  ))
)
```
