---
title: "Topic extraction with LLM"
output: 
  html_document:
    theme:
      version: 5
      bootswatch: lux
params:
  result_list: !r list(df = data.frame(result = c("A"), text = c("A")), paragraphs = list(A = list(paragraph = "Paragraaf over onderwerp 'A', we quoten de tekst \"A\"... En quoten een tekst die niet bestaat, \"B\"... En nogmaals \"A\"...", texts = c("A"))), model = "gpt-4o", model_reductie = "o1", irr = list(subjects = 20, raters = 2, irr.name = "Kappa", stat.name = "z", statistic = 1.163762, p.value = 0.243845, value = 0.119469))
---

```{r include=FALSE, error=TRUE}
library(stringr)
rl <- params$result_list
source(here::here("R", "report_datatable_config.R"), local = TRUE)
source(here::here("R", "report_quote_utils.R"), local = TRUE)
```

## Method

`r nrow(rl$df)` texts have been analyzed with a language model,
to discover which different topics are mentioned in the texts
and how often.

A topic modeling procedure has been applied based on
[Wanrooij, Manhar, and Yang (2024)](https://bnaic2024.sites.uu.nl/wp-content/uploads/sites/986/2024/10/Topic-Modeling-for-Small-Data-using-Generative-LLMs.pdf)
and [Pham et al. (2023)](https://arxiv.org/abs/2311.01449). This procedure consists of 3 steps:

* In step 1, the texts are presented to the LLM in randomly drawn groups
of up to 5 texts, asking it to respond with possible topics
that are neither too specific nor too general. This forms the list of possible topics.
For this step, the model `r htmltools::htmlEscape(rl$model)` has been used.

* In step 2, the list of possible topics
is presented to the LLM, asking it to reduce the list of topics
to a final list without duplications and also avoiding overly specific
or overly general topics. This forms the list of final topics.
For this step, the model `r htmltools::htmlEscape(rl$model_reductie)` has been used.

```{r echo=FALSE, results='asis', error=TRUE}  
multiple_categories_text <- "The LLM was required to assign one category per text"
if (isTRUE(rl$assign_multiple_categories)) {
  multiple_categories_text <- "The LLM was allowed to assign multiple categories per text (at least one category per text)"
}
```

* In step 3, each text is presented individually to the LLM,
along with the list of final topics, asking it to assign these topics to the text.
`r multiple_categories_text`. For this step, the model `r htmltools::htmlEscape(rl$model)` has been used.

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$paragraphs)) {
  cat(paste0(
    "With the texts to which subjects were added, a language model ",
  "(", htmltools::htmlEscape(rl$model), ") finally wrote a report.", "\n",
    "For each subject, a summary was created with quotes summarizing what was said."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
research_background <- rl$research_background
research_background <- htmltools::htmlEscape(research_background)
if (
  !is.null(rl$research_background)
  && research_background != ""
) {
  cat(paste0(
    "### Research background\n",
    "The user provided the following background information about the research:\n\n",
    "<blockquote><i>",
  research_background,
    "</i></blockquote>", "\n\n",
    "This information was added to each prompt sent to the language model, so that it could better understand the context of the research."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$irr)) {
  cat(paste0(
    "### Reliability\n",
    "The inter-rater reliability between the language model and a human rater was calculated. ",
    "A random sample of ",
    rl$irr$subjects, " texts was taken.",
    " The calculated inter-rater reliability is ",
    round(rl$irr$value, 3), " (", rl$irr$irr.name, "; ", rl$irr$stat.name, " = ",
    round(rl$irr$statistic, 3), ", p = ", round(rl$irr$p.value, 3), ").",
    " This can be interpreted as a ",
    dplyr::case_when(
      rl$irr$value < 0 ~ "poor",
      rl$irr$value < 0.2 ~ "slight",
      rl$irr$value < 0.4 ~ "fair",
      rl$irr$value < 0.6 ~ "moderate",
      rl$irr$value < 0.8 ~ "substantial",
      rl$irr$value < 1 ~ "almost perfect",
      TRUE ~ "perfect"
    ),
    " agreement between the language model and the human rater ([Landis & Koch, 1977](https://doi.org/10.2307/2529310))."
  ))
}
```

## Results

### Frequency

Below table shows the topics that have been identified and how often
they were mentioned in the texts.

```{r, echo=FALSE, results='asis', error=TRUE}

if (!isTRUE(rl$assign_multiple_categories)) {
  rl$df |>
  dplyr::group_by(result) |>
  dplyr::summarise(
    Number = dplyr::n(),
    Percentage = round(dplyr::n() / nrow(rl$df) * 100, 2)
  ) |>
  dplyr::arrange(dplyr::desc(Number)) |>
  dplyr::rename(Topic = result) |>
  DT::datatable(
    rownames = FALSE,
    extensions = 'Buttons',
    options = get_datatable_options_en(additional_options = list(fixedHeader = TRUE))
  )
} else {
  rl$df |>
    dplyr::select(-text) |>
    # For each binary category column, count the number of TRUE values
    dplyr::summarise(dplyr::across(dplyr::everything(), ~ sum(.x, na.rm = TRUE))) |>
    tidyr::pivot_longer(
      cols = dplyr::everything(),
      names_to = "Topic",
      values_to = "Number"
    ) |>
    dplyr::mutate(
      Percentage = round(Number / nrow(rl$df) * 100, 2)
    ) |>
    dplyr::arrange(dplyr::desc(Number)) |>
    DT::datatable(
      rownames = FALSE,
      extensions = 'Buttons',
      options = get_datatable_options_en()
    )
}


```

### Per text

Below table shows the assigned topic for each text.

```{r, echo=FALSE, results='asis', error=TRUE}
if (!isTRUE(rl$assign_multiple_categories)) {
  rl$df |>
  dplyr::select(result, text) |>
  dplyr::rename(Text = text, Topic = result) |>
  dplyr::arrange(dplyr::desc(Topic)) |>
  DT::datatable(
    extensions = 'Buttons',
    options = get_datatable_options_en(additional_options = list(fixedHeader = TRUE))
  )
} else {
  rl$df |>
    dplyr::rename(Text = text) |>
    dplyr::arrange(dplyr::desc(Text)) |>
    DT::datatable(
      options = get_datatable_options_en()
    )
}
```
 
```{r echo=FALSE, results='asis', error=TRUE}
if (is.null(rl$paragraphs)) return(invisible(NULL))

output <- list()

output <- append(output, list(
  htmltools::HTML("<h3>Report</h3>"),
  htmltools::HTML("<p>The following paragraphs are the summaries of the texts per topic.</p>"),
  htmltools::div(
    class = "d-flex justify-content-center",
    htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "alert alert-warning p-2 text-center",
        style = "max-width: 500px; font-size: 0.9rem;",
        htmltools::tags$div(
          class = "d-flex align-items-center",
          bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
          htmltools::tags$small(
            htmltools::tags$i(
              "Language models can 'hallucinate'.",
              " Check whether the summaries are supported by the texts.",
              " Icons next to quotes indicate whether they appear in the texts."
            )
          )
        )
      )
    )
  )
))

## quote utils loaded from report_quote_utils.R

for (i in seq_along(rl$paragraphs)) {
  paragraph <- rl$paragraphs[[i]]
  topic <- htmltools::htmlEscape(paragraph$topic)
  paragraph_text <- htmltools::htmlEscape(paragraph$paragraph)
  
  supporting_texts <- paste(htmltools::htmlEscape(paragraph$texts), collapse = " ")
  if (length(supporting_texts) == 0) {
    next
  }
  
  #### 1 Verify quotes on presence in supporting texts ####
  paragraph_text <- verify_and_decorate_quotes(
    paragraph_text = paragraph_text,
    supporting_texts = supporting_texts,
    lang = "en",
    escape_html = FALSE
  )
  
  #### 2 Check if paragraph has attribute about prompt not fitting in context window ####
  
  # If paragraph has attribute 'prompt_fits' and it is FALSE, add a warning
  #   to the output
  warning_context_window <- NULL
  prompt_fits <- paragraph$prompt_fits
  if (isFALSE(prompt_fits)) {
    warning_context_window <- htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "d-flex justify-content-center",
        htmltools::div(
          class = "alert alert-warning p-2 text-center",
          style = "max-width: 500px; font-size: 0.9rem;",
          htmltools::tags$div(
            class = "d-flex align-items-center",
            bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
            htmltools::tags$small(
              htmltools::tags$i(
                "The prompt for the summary of this category did",
                " not fit in the context window of the language model.",
                " It is possible that not all instructions or texts were seen by the language model."
              )
            )
          )
        )
      )
    )
  }
  
  # Append processed output
  output <- append(output, list(
  htmltools::HTML(paste0("<h4>", topic, "</h4>")),
    warning_context_window,
    htmltools::HTML(paste0("<p>", paragraph_text, "</p>"))
  ))

  if (!is.null(paragraph$texts)) {
  acc <- bslib::accordion(
      bslib::accordion_panel(
        title = "View texts",
        htmltools::HTML(paste0("<ul>", paste0("<li><i>", htmltools::htmlEscape(paragraph$texts), "</i></li>", collapse = ""), "</ul>")),
      ),
      id = paste0("acc-", i),
      open = FALSE
    )
    output <- append(output, list(acc))
  }

  output <- append(output, list(htmltools::HTML("<br>")))
}

if (length(rl$paragraphs) > 0) {
  htmltools::tagList(output)
}
``` 

```{r footer, echo=FALSE, results='asis', error=TRUE}
htmltools::tags$footer(
  style = "text-align:center; font-size: 0.8em; color: #888; margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee;",
  htmltools::HTML(paste0(
    "This analysis was performed by KWALLM, an open-source app for automated qualitative text analysis.<br>Developed by ",
    "<a href='https://www.kennispunttwente.nl' target='_blank'>Kennispunt Twente</a> in collaboration with GGD Twente.<br>",
    "Visit the <a href='https://github.com/kennispunttwente/tekstanalyse_met_llm' target='_blank'>GitHub-repository</a> for more information.",
    "<br>",
    "<br>",
    format(Sys.Date(), "%Y-%m-%d")
  ))
)
```
