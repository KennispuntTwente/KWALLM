---
title: "Categorization with LLM"
output: 
  html_document:
    theme:
      version: 5
      bootswatch: lux
params:
  result_list: !r list(df = data.frame(text = c("a", "b", "c"), result = c("A", "B", "C")), categories = c("A", "B", "C"), scoring_characteristic = "onderwerp", model = "gpt-4o", irr = list(subjects = 20, raters = 2, irr.name = "Kappa", stat.name = "z", statistic = 1.163762, p.value = 0.243845, value = 0.119469), research_background = "my research background")
---

```{r include=FALSE, error=TRUE}
rl <- params$result_list
source(here::here("R", "report_datatable_config.R"), local = TRUE)
source(here::here("R", "report_quote_utils.R"), local = TRUE)
```

## Method

`r nrow(rl$df)` texts were analyzed with a LLM (model: `r htmltools::htmlEscape(rl$model)`),
during which the LLM was asked to assign one of the following `r length(rl$categories)` categories to each text:

```{r echo=FALSE, results='asis', error=TRUE}
cat("<blockquote>")
safe_categories <- vapply(rl$categories, htmltools::htmlEscape, character(1))
cat(paste0("* *", safe_categories, "*"), sep = "\n")
cat("</blockquote>")
```

```{r echo=FALSE, results='asis', error=TRUE}  
multiple_categories_text <- "The LLM was required to assign one category per text"
if (isTRUE(rl$assign_multiple_categories)) {
  multiple_categories_text <- "The LLM was allowed to assign multiple categories per text (at least one category per text)"
}
```

`r multiple_categories_text`. Every text was presented separately to the LLM.

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$paragraphs)) {
  cat(paste0(
    "With the texts to which subjects were added, a language model ",
  "(", htmltools::htmlEscape(rl$model), ") finally wrote a report.", "\n",
    "For each subject, a summary was created with quotes summarizing what was said."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
research_background <- rl$research_background
if (
  !is.null(rl$research_background)
  && research_background != ""
) {
  cat(paste0(
    "### Research background\n",
    "The user provided the following background information about the research:\n\n",
  "<blockquote><i>",
  htmltools::htmlEscape(research_background),
  "</i></blockquote>", "\n\n",
    "This information was added to each prompt sent to the language model, so that it could better understand the context of the research."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$irr)) {
  cat(paste0(
    "### Reliability\n",
    "The inter-rater reliability between the language model and a human rater was calculated. ",
    "A random sample of ",
    rl$irr$subjects, " texts was taken.",
    " The calculated inter-rater reliability is ",
    round(rl$irr$value, 3), " (", rl$irr$irr.name, "; ", rl$irr$stat.name, " = ",
    round(rl$irr$statistic, 3), ", p = ", round(rl$irr$p.value, 3), ").",
    " This can be interpreted as a ",
    dplyr::case_when(
      rl$irr$value < 0 ~ "poor",
      rl$irr$value < 0.2 ~ "slight",
      rl$irr$value < 0.4 ~ "fair",
      rl$irr$value < 0.6 ~ "moderate",
      rl$irr$value < 0.8 ~ "substantial",
      rl$irr$value < 1 ~ "almost perfect",
      TRUE ~ "perfect"
    ),
    " agreement between the language model and the human rater ([Landis & Koch, 1977](https://doi.org/10.2307/2529310))."
  ))
}
```

## Results

### Frequency

The below table shows how often each category was assigned.

```{r, echo=FALSE, results='asis', error=TRUE}

if (!isTRUE(rl$assign_multiple_categories)) {
  rl$df |>
    dplyr::count(result, name = "Number") |>
    tidyr::complete(result = rl$categories, fill = list(Number = 0)) |>
    dplyr::mutate(
      Percentage = round(Number / nrow(rl$df) * 100, 2)
    ) |>
    dplyr::rename(Category = result) |>
    dplyr::arrange(Category) |>
    DT::datatable(
      rownames = FALSE,
      extensions = 'Buttons',
      options = get_datatable_options_en()
    )
} else {
  rl$df |>
    dplyr::select(-text) |>
    # For each binary category column, count the number of TRUE values
    dplyr::summarise(dplyr::across(dplyr::everything(), ~ sum(.x, na.rm = TRUE))) |>
    tidyr::pivot_longer(
      cols = dplyr::everything(),
      names_to = "Category",
      values_to = "Number"
    ) |>
    dplyr::mutate(
      Percentage = round(Number / nrow(rl$df) * 100, 2)
    ) |>
    dplyr::arrange(dplyr::desc(Number)) |>
    DT::datatable(
      rownames = FALSE,
      extensions = 'Buttons',
      options = get_datatable_options_en()
    )
}


```

### Per text

The below table shows the categories assigned to each text.

```{r echo=FALSE, results='asis', error=TRUE}
if (!isTRUE(rl$assign_multiple_categories)) {
  rl$df |>
  dplyr::select(result, text) |>
  dplyr::rename(Text = text, Category = result) |>
  dplyr::arrange(Category) |>
  DT::datatable(
    options = get_datatable_options_en()
  )
} else {
  rl$df |>
    dplyr::rename(Text = text) |>
    dplyr::arrange(dplyr::desc(Text)) |>
    DT::datatable(
      options = get_datatable_options_en()
    )
}
```
 
```{r echo=FALSE, results='asis', error=TRUE}
if (is.null(rl$paragraphs)) return(invisible(NULL))

output <- list()

output <- append(output, list(
  htmltools::HTML("<h3>Report</h3>"),
  htmltools::HTML("<p>The following paragraphs are the summaries of the texts per topic.</p>"),
  htmltools::div(
    class = "d-flex justify-content-center",
    htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "alert alert-warning p-2 text-center",
        style = "max-width: 500px; font-size: 0.9rem;",
        htmltools::tags$div(
          class = "d-flex align-items-center",
          bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
          htmltools::tags$small(
            htmltools::tags$i(
              "Language models can 'hallucinate'.",
              " Check whether the summaries are supported by the texts.",
              " Icons next to quotes indicate whether they appear in the texts."
            )
          )
        )
      )
    )
  )
))

## quote utils loaded from report_quote_utils.R

for (i in seq_along(rl$paragraphs)) {
  paragraph <- rl$paragraphs[[i]]
  topic <- paragraph$topic
  paragraph_text <- paragraph$paragraph
  
  supporting_texts <- paste(paragraph$texts, collapse = " ")
  if (length(supporting_texts) == 0) {
    next
  }
  
  #### 1 Verify quotes on presence in supporting texts ####
  paragraph_text <- verify_and_decorate_quotes(
    paragraph_text = paragraph_text,
    supporting_texts = supporting_texts,
    lang = "en",
    escape_html = TRUE
  )
  
  #### 2 Check if paragraph has attribute about prompt not fitting in context window ####
  
  # If paragraph has attribute 'prompt_fits' and it is FALSE, add a warning
  #   to the output
  warning_context_window <- NULL
  prompt_fits <- paragraph$prompt_fits
  if (isFALSE(prompt_fits)) {
    warning_context_window <- htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "d-flex justify-content-center",
        htmltools::div(
          class = "alert alert-warning p-2 text-center",
          style = "max-width: 500px; font-size: 0.9rem;",
          htmltools::tags$div(
            class = "d-flex align-items-center",
            bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
            htmltools::tags$small(
              htmltools::tags$i(
                "The prompt for the summary of this category did",
                " not fit in the context window of the language model.",
                " It is possible that not all instructions or texts were seen by the language model."
              )
            )
          )
        )
      )
    )
  }
  
  # Append processed output
  output <- append(output, list(
    htmltools::HTML(paste0("<h4>", htmltools::htmlEscape(topic), "</h4>")),
    warning_context_window,
    htmltools::HTML(paste0("<p>", paragraph_text, "</p>"))
  ))

  if (!is.null(paragraph$texts)) {
    acc <- bslib::accordion(
      bslib::accordion_panel(
        title = "View texts",
        htmltools::HTML(paste0(
          "<ul>",
          paste0(
            "<li><i>",
            vapply(paragraph$texts, htmltools::htmlEscape, character(1)),
            "</i></li>",
            collapse = ""
          ),
          "</ul>"
        )),
      ),
      id = paste0("acc-", i),
      open = FALSE
    )
    output <- append(output, list(acc))
  }

  output <- append(output, list(htmltools::HTML("<br>")))
}

if (length(rl$paragraphs) > 0) {
  htmltools::tagList(output)
}
``` 
 
```{r footer, echo=FALSE, results='asis', error=TRUE}
htmltools::tags$footer(
  style = "text-align:center; font-size: 0.8em; color: #888; margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee;",
  htmltools::HTML(paste0(
    "This analysis was performed by KWALLM, an open-source app for automated qualitative text analysis.<br>Developed by ",
    "<a href='https://www.kennispunttwente.nl' target='_blank'>Kennispunt Twente</a> in collaboration with GGD Twente.<br>",
    "Visit the <a href='https://github.com/kennispunttwente/tekstanalyse_met_llm' target='_blank'>GitHub-repository</a> for more information.",
    "<br>",
    "<br>",
    format(Sys.Date(), "%Y-%m-%d")
  ))
)
```
