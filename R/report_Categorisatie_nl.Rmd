---
title: "Categoriseren met LLM"
output: 
  html_document:
    theme:
      version: 5
      bootswatch: lux
params:
  result_list: !r list(df = data.frame(text = c("a", "b", "c"), result = c("A", "B", "C")), categories = c("A", "B", "C"), scoring_characteristic = "onderwerp", model = "gpt-4o", irr = list(subjects = 20, raters = 2, irr.name = "Kappa", stat.name = "z", statistic = 1.163762, p.value = 0.243845, value = 0.119469), research_background = "my research background")
---

```{r include=FALSE, error=TRUE}
rl <- params$result_list
source(here::here("R", "report_datatable_config.R"), local = TRUE)
source(here::here("R", "report_quote_utils.R"), local = TRUE)
```

## Methode

Er zijn `r nrow(rl$df)` teksten geanalyseerd met een LLM (model: `r htmltools::htmlEscape(rl$model)`),
waarbij het LLM gevraagd werd om het in te delen in één van de volgende `r length(rl$categories)` categorieën:

```{r echo=FALSE, results='asis', error=TRUE}
cat("<blockquote>")
safe_categories <- vapply(rl$categories, htmltools::htmlEscape, character(1))
cat(paste0("* *", safe_categories, "*"), sep = "\n")
cat("</blockquote>")
```

```{r echo=FALSE, results='asis', error=TRUE}  
multiple_categories_text <- "Het LLM moest één categorie toewijzen per tekst"
if (isTRUE(rl$assign_multiple_categories)) {
  multiple_categories_text <- "Het LLM mocht meerdere categorieën toewijzen per tekst (minimaal één categorie per tekst)"
}
```

`r multiple_categories_text`. Elke tekst is afzonderlijk gepresenteerd aan het LLM.

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$paragraphs)) {
  cat(paste0(
    "Met de teksten waaraan onderwerpen zijn toegevoegd, heeft een taalmodel ",
  "(", htmltools::htmlEscape(rl$model), ") tenslotte een rapport geschreven.", "\n",
    "Per onderwerp is met quotes samengevat wat er is gezegd."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
research_background <- rl$research_background
if (
  !is.null(rl$research_background)
  && research_background != ""
) {
  cat(paste0(
    "### Onderzoeksachtergrond\n",
    "De gebruiker heeft de volgende achtergrondinformatie over het onderzoek opgegeven:\n\n",
  "<blockquote><i>",
  htmltools::htmlEscape(research_background),
  "</i></blockquote>", "\n\n",
    "Deze informatie is toegevoegd aan elke prompt die naar het taalmodel is gestuurd, zodat het beter de context van het onderzoek kon begrijpen."
  ))
}
```

```{r echo=FALSE, results='asis', error=TRUE}
if (!is.null(rl$irr)) {
  cat(paste0(
    "### Betrouwbaarheid\n",
    "De interbeoordelaarsbetrouwbaarheid tussen het taalmodel en een menselijke beoordelaar berekend.",
    " Hiervoor is een willekeurige steekproef genomen van " , 
    rl$irr$subjects, " teksten.",
    " De berekende interbeoordelaarsbetrouwbaarheid is ",
    round(rl$irr$value, 3), " (", rl$irr$irr.name, "; ", rl$irr$stat.name, " = ", 
    round(rl$irr$statistic, 3), ", p = ", round(rl$irr$p.value, 3), ").",
    " Dit valt te interpreteren als een ",
    dplyr::case_when(
      rl$irr$value < 0 ~ "slechte ('poor')",
      rl$irr$value < 0.2 ~ "zwakke ('slight')",
      rl$irr$value < 0.4 ~ "matige ('fair')",
      rl$irr$value < 0.6 ~ "redelijke ('moderate')",
      rl$irr$value < 0.8 ~ "goede ('substantial')",
      rl$irr$value < 1 ~ "zeer goede ('almost perfect')",
      TRUE ~ "perfecte"
    ),
    " overeenstemming tussen het taalmodel en de menselijke beoordelaar ([Landis & Koch, 1977](https://doi.org/10.2307/2529310))."
  ))
}
```

## Resultaten

### Frequentie

Onderstaande tabel toont hoe vaak elke categorie is toegewezen.

```{r, echo=FALSE, results='asis', error=TRUE}

if (!isTRUE(rl$assign_multiple_categories)) {
  rl$df |>
    dplyr::count(result, name = "Aantal") |>
    tidyr::complete(result = rl$categories, fill = list(Aantal = 0)) |>
    dplyr::mutate(
      Percentage = round(Aantal / nrow(rl$df) * 100, 2)
    ) |>
    dplyr::rename(Categorie = result) |>
    dplyr::arrange(Categorie) |>
    DT::datatable(
      rownames = FALSE,
      extensions = 'Buttons',
      options = get_datatable_options()
    )
} else {
  rl$df |>
    dplyr::select(-text) |>
    # For each binary category column, count the number of TRUE values
    dplyr::summarise(dplyr::across(dplyr::everything(), ~ sum(.x, na.rm = TRUE))) |>
    tidyr::pivot_longer(
      cols = dplyr::everything(),
      names_to = "Categorie",
      values_to = "Aantal"
    ) |>
    dplyr::mutate(
      Percentage = round(Aantal / nrow(rl$df) * 100, 2)
    ) |>
    dplyr::arrange(dplyr::desc(Aantal)) |>
    DT::datatable(
      rownames = FALSE,
      extensions = 'Buttons',
      options = get_datatable_options()
    )
}


```

### Per tekst

Onderstaande tabel de categorieën per tekst.

```{r echo=FALSE, results='asis', error=TRUE}
if (!isTRUE(rl$assign_multiple_categories)) {
  rl$df |>
  dplyr::select(result, text) |>
  dplyr::rename(Tekst = text, Categorie = result) |>
  dplyr::arrange(Categorie) |>
  DT::datatable(
    options = get_datatable_options()
  )
} else {
  rl$df |>
    dplyr::rename(Tekst = text) |>
    dplyr::arrange(dplyr::desc(Tekst)) |>
    DT::datatable(
      options = get_datatable_options()
    )
}
```
 
```{r echo=FALSE, results='asis', error=TRUE}
if (is.null(rl$paragraphs)) return(invisible(NULL))

output <- list()

output <- append(output, list(
  htmltools::HTML("<h3>Rapport</h3>"),
  htmltools::HTML("<p>Onderstaande paragrafen zijn de samenvattingen van de teksten per onderwerp.</p>"),
  htmltools::div(
    class = "d-flex justify-content-center",
    htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "alert alert-warning p-2 text-center",
        style = "max-width: 500px; font-size: 0.9rem;",
        htmltools::tags$div(
          class = "d-flex align-items-center",
          bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
          htmltools::tags$small(
            htmltools::tags$i(
              "Taalmodellen kunnen 'hallucineren'.",
              " Controleer of de samenvattingen worden ondersteund door de teksten.",
              " Iconen bij quotes geven aan of ze voorkomen in de teksten."
            )
          )
        )
      )
    )
  )
))

## quote utils loaded from report_quote_utils.R

for (i in seq_along(rl$paragraphs)) {
  paragraph <- rl$paragraphs[[i]]
  topic <- htmltools::htmlEscape(paragraph$topic)
  paragraph_text <- htmltools::htmlEscape(paragraph$paragraph)
  
  supporting_texts <- paste(htmltools::htmlEscape(paragraph$texts), collapse = " ")
  if (length(supporting_texts) == 0) {
    next
  }
  
  #### 1 Verify quotes on presence in supporting texts ####
  paragraph_text <- verify_and_decorate_quotes(
    paragraph_text = paragraph_text,
    supporting_texts = supporting_texts,
    lang = "nl",
    escape_html = TRUE
  )
  
  #### 2 Check if paragraph has attribute about prompt not fitting in context window ####
  
  # If paragraph has attribute 'prompt_fits' and it is FALSE, add a warning
  #   to the output
  warning_context_window <- NULL
  prompt_fits <- paragraph$prompt_fits
  if (isFALSE(prompt_fits)) {
    warning_context_window <- htmltools::div(
      class = "d-flex justify-content-center",
      htmltools::div(
        class = "d-flex justify-content-center",
        htmltools::div(
          class = "alert alert-warning p-2 text-center",
          style = "max-width: 500px; font-size: 0.9rem;",
          htmltools::tags$div(
            class = "d-flex align-items-center",
            bsicons::bs_icon("exclamation-triangle-fill", class = "me-2 fs-1"),
            htmltools::tags$small(
              htmltools::tags$i(
                "De prompt voor de samenvatting van deze categorie paste",
                " niet in het context-window van het taalmodel.",
                " Mogelijk zijn niet alle instructies of teksten door het taalmodel gezien."
              )
            )
          )
        )
      )
    )
  }
  
  # Append processed output
  output <- append(output, list(
    htmltools::HTML(paste0("<h4>", topic, "</h4>")),
    warning_context_window,
    htmltools::HTML(paste0("<p>", paragraph_text, "</p>"))
  ))

  if (!is.null(paragraph$texts)) {
    acc <- bslib::accordion(
      bslib::accordion_panel(
        title = "Bekijk teksten",
        htmltools::HTML(paste0(
          "<ul>",
          paste0(
            "<li><i>",
            vapply(paragraph$texts, htmltools::htmlEscape, character(1)),
            "</i></li>",
            collapse = ""
          ),
          "</ul>"
        )),
      ),
      id = paste0("acc-", i),
      open = FALSE
    )
    output <- append(output, list(acc))
  }

  output <- append(output, list(htmltools::HTML("<br>")))
}

if (length(rl$paragraphs) > 0) {
  htmltools::tagList(output)
}
``` 
 
```{r footer, echo=FALSE, results='asis', error=TRUE}
htmltools::tags$footer(
  style = "text-align:center; font-size: 0.8em; color: #888; margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee;",
  htmltools::HTML(paste0(
    "Deze analyse is uitgevoerd met KWALLM, een open-source app voor automatische kwalitatieve tekstanalyse.<br>Ontwikkeld door ",
    "<a href='https://www.kennispunttwente.nl' target='_blank'>Kennispunt Twente</a> in samenwerking met GGD Twente.<br>",
    "Bezoek de <a href='https://github.com/kennispunttwente/KWALLM' target='_blank'>GitHub-repository</a> voor meer informatie.",
    "<br>",
    "<br>",
    format(Sys.Date(), "%Y-%m-%d")
  ))
)
```
